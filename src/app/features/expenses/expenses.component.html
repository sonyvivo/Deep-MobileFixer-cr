<!-- LIST VIEW -->
<div class="card" *ngIf="viewMode === 'list'">
    <div class="card-header">
        <div class="card-title">Expense Management</div>
        <button class="btn btn-primary" (click)="openAddExpense()">
            <i class="fas fa-plus-circle"></i> Add Expense
        </button>
    </div>

    <!-- Summary (Visible in List View) -->
    <div class="card" style="margin: 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #eee;">
        <div class="card-header" style="border-bottom: 1px solid rgba(0,0,0,0.05);">
            <div class="card-title" style="font-size: 1.1rem;">Expense Overview</div>
        </div>
        <div class="summary-grid" style="padding: 20px;">
            <div class="summary-card">
                <div class="summary-icon" style="color: var(--danger);">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="summary-value">₹{{ totalThisMonth.toFixed(2) }}</div>
                <div class="summary-label">This Month</div>
            </div>
            <div class="summary-card">
                <div class="summary-icon" style="color: var(--warning);">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="summary-value">₹{{ totalThisYear.toFixed(2) }}</div>
                <div class="summary-label">This Year</div>
            </div>
            <div class="summary-card">
                <div class="summary-icon" style="color: var(--info);">
                    <i class="fas fa-tools"></i>
                </div>
                <div class="summary-value">₹{{ toolsExpenses.toFixed(2) }}</div>
                <div class="summary-label">Tools (Total)</div>
            </div>
            <div class="summary-card">
                <div class="summary-icon" style="color: var(--success);">
                    <i class="fas fa-gas-pump"></i>
                </div>
                <div class="summary-value">₹{{ petrolExpenses.toFixed(2) }}</div>
                <div class="summary-label">Petrol (Total)</div>
            </div>
        </div>
    </div>

    <div class="filter-controls">
        <div class="form-group">
            <label>Filter Month</label>
            <div style="display: flex; gap: 5px;">
                <select class="form-control" [(ngModel)]="selectedMonth" (ngModelChange)="onFilterChange()">
                    <option *ngFor="let m of months" [value]="m.value">{{ m.name }}</option>
                </select>
                <select class="form-control" [(ngModel)]="selectedYear" (ngModelChange)="onFilterChange()">
                    <option *ngFor="let y of years" [value]="y">{{ y }}</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>From</label>
            <input type="date" class="form-control" [(ngModel)]="filterDateFrom">
        </div>
        <div class="form-group">
            <label>To</label>
            <input type="date" class="form-control" [(ngModel)]="filterDateTo">
        </div>
        <div class="form-group">
            <label>Category</label>
            <select class="form-control" [(ngModel)]="filterCategory">
                <option value="">All Categories</option>
                <option value="Tools & Equipment">Tools & Equipment</option>
                <option value="Petrol & Transportation">Petrol & Transportation</option>
                <option value="Shop Rent">Shop Rent</option>
                <option value="Utilities">Utilities</option>
                <option value="Marketing">Marketing</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div class="form-group">
            <label>Search</label>
            <input type="text" class="form-control" [(ngModel)]="filterSearch" placeholder="Description...">
        </div>
        <div class="button-group">
            <button class="btn btn-primary" (click)="applyFilters()">Filter</button>
            <button class="btn btn-info" (click)="resetFilters()">Reset</button>
            <button class="btn btn-success" (click)="exportPDF()"><i class="fas fa-file-pdf"></i></button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Payment</th>
                    <th>Amount</th>
                    <th>Receipt</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let e of filteredExpenses">
                    <td>{{ e.date }}</td>
                    <td><span class="badge" [ngClass]="getCategoryClass(e.category)">{{ e.category }}</span></td>
                    <td>{{ e.description }}<br><small style="color:var(--gray)">{{ e.vendor || '' }}</small></td>
                    <td><span class="badge" [ngClass]="getPaymentBadgeClass(e.paymentMode)">{{ e.paymentMode }}</span>
                    </td>
                    <td style="color:var(--danger); font-weight:600;">₹{{ e.amount.toFixed(2) }}</td>
                    <td>
                        <span class="badge" [ngClass]="{
                              'badge-success': e.receipt === 'Yes',
                              'badge-info': e.receipt === 'Digital',
                              'badge-primary': e.receipt === 'Bill',
                              'badge-secondary': e.receipt === 'No'
                          }">
                            <i class="fas" [ngClass]="{
                              'fa-receipt': e.receipt === 'Yes',
                              'fa-file-invoice': e.receipt === 'Digital',
                              'fa-file-alt': e.receipt === 'Bill'
                          }"></i>
                            {{ e.receipt }}
                        </span>
                    </td>
                    <td>
                        <button class="btn-sm btn-primary" (click)="openEditExpense(e)"><i
                                class="fas fa-edit"></i></button>
                        <button class="btn-sm btn-danger ml-1" (click)="deleteExpense(e.id)"><i
                                class="fas fa-trash"></i></button>
                    </td>
                </tr>
                <tr *ngIf="filteredExpenses.length === 0">
                    <td colspan="7" class="text-center">No Expenses Found</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- FORM VIEW -->
<div class="form-view-container" *ngIf="viewMode === 'form'">
    <div class="header no-print">
        <h1>{{ editingExpense.id ? 'Edit Expense' : 'Add Expense' }}</h1>
        <button class="btn btn-secondary" (click)="cancelEdit()">
            <i class="fas fa-arrow-left"></i> Back
        </button>
    </div>

    <div class="card form-card">
        <form (ngSubmit)="saveExpense()">
            <div class="form-container">
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-info-circle"></i> Details
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" class="form-control" [(ngModel)]="editingExpense.date" name="date" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select class="form-control" [(ngModel)]="editingExpense.category" name="category" required>
                            <option value="">Select Category</option>
                            <option value="Tools & Equipment">Tools & Equipment</option>
                            <option value="Petrol & Transportation">Petrol & Transportation</option>
                            <option value="Shop Rent">Shop Rent</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" [(ngModel)]="editingExpense.description" name="desc" rows="2"
                            required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Vendor</label>
                        <input type="text" class="form-control" [(ngModel)]="editingExpense.vendor" name="vendor"
                            placeholder="Optional">
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-file-invoice-dollar"></i> Payment
                    </div>
                    <div class="form-group">
                        <label>Amount (₹)</label>
                        <input type="number" class="form-control" [(ngModel)]="editingExpense.amount" name="amount"
                            required>
                    </div>
                    <div class="form-group">
                        <label>Payment Mode</label>
                        <select class="form-control" [(ngModel)]="editingExpense.paymentMode" name="paymentMode"
                            required>
                            <option value="Cash">Cash</option>
                            <option value="Online">Online</option>
                            <option value="Card">Card</option>
                            <option value="Cheque">Cheque</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Receipt Available?</label>
                        <select class="form-control" [(ngModel)]="editingExpense.receipt" name="receipt">
                            <option value="No">No Receipt</option>
                            <option value="Yes">Yes, I have receipt</option>
                            <option value="Digital">Digital Receipt</option>
                            <option value="Bill">Bill Available</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Receipt Number</label>
                        <input type="text" class="form-control" [(ngModel)]="editingExpense.receiptNumber"
                            name="receiptNumber" placeholder="Optional">
                    </div>
                </div>
            </div>

            <div class="form-actions text-right"
                style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                <button type="button" class="btn btn-secondary mr-2" (click)="cancelEdit()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Expense</button>
            </div>
        </form>
    </div>
</div>

<app-confirm-modal [isVisible]="isConfirmOpen" (confirm)="confirmDelete()"
    (cancel)="isConfirmOpen=false"></app-confirm-modal>