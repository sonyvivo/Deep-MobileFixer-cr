<div class="header no-print">
    <h1><i class="fas fa-file-invoice"></i> Billing / Invoices</h1>
    <div class="quick-actions" *ngIf="$any(viewMode) === 'list'">
        <button class="btn btn-primary" (click)="openNewInvoice()">
            <i class="fas fa-plus"></i> New Invoice
        </button>
    </div>
    <div class="quick-actions" *ngIf="$any(viewMode) !== 'list'">
        <button class="btn btn-secondary" (click)="setView('list')">
            <i class="fas fa-arrow-left"></i> Back to List
        </button>
    </div>
</div>

<!-- ================= LIST VIEW ================= -->
<div class="card no-print" *ngIf="$any(viewMode) === 'list'">
    <div class="card-header">
        <div class="card-title">All Invoices</div>
    </div>
    <div class="card-body">
        <div class="filter-controls" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <select class="form-control" [(ngModel)]="filterStatus" (change)="applyFilter()" style="max-width: 200px;">
                <option *ngFor="let s of paymentStatuses" [value]="s">{{ s }}</option>
            </select>
            <input type="text" class="form-control" [(ngModel)]="searchQuery" (input)="applyFilter()"
                placeholder="Search by Customer, Mobile, or Invoice ID..." autocomplete="off" style="flex: 1;">
            <button class="btn btn-secondary" (click)="resetFilters()">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>

        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Mobile</th>
                        <th>Type</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let inv of filteredInvoices">
                        <td><strong>{{ inv.id }}</strong></td>
                        <td>{{ inv.date | date:'shortDate' }}</td>
                        <td>{{ inv.customerName }}</td>
                        <td>{{ inv.customerMobile }}</td>
                        <td>{{ inv.deviceType }}</td>
                        <td>{{ inv.totalAmount | currency:'INR' }}</td>
                        <td>
                            <span class="badge"
                                [class.badge-success]="inv.paymentStatus === 'Paid' || inv.paymentStatus === 'Cash' || inv.paymentStatus === 'Google Pay'"
                                [class.badge-danger]="inv.paymentStatus === 'Pending'">
                                {{ inv.paymentStatus }}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" (click)="editInvoice(inv)" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-success" (click)="shareOnWhatsApp(inv)" title="WhatsApp"
                                style="margin-left: 5px; background: #25D366; border-color: #25D366;">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" (click)="printInvoiceDirect(inv)" title="Print"
                                style="margin-left: 5px;">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" (click)="deleteInvoice(inv.id)" title="Delete"
                                style="margin-left: 5px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    <tr *ngIf="invoices.length === 0">
                        <td colspan="8" style="text-align: center; padding: 20px;">No invoices found. Create one now!
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- ================= FORM SECTION ================= -->
<div class="card no-print" *ngIf="$any(viewMode) === 'form'">
    <div class="card-header">
        <div class="card-title">
            <span *ngIf="!currentInvoice.id">New Invoice</span>
            <span *ngIf="currentInvoice.id">Edit Invoice: {{ currentInvoice.id }}</span>
        </div>
        <div class="invoice-details" style="text-align: right;">
            <p>{{ currentInvoice.date | date:'medium' }}</p>
        </div>
    </div>

    <form>
        <!-- Customer Info -->
        <div class="form-section-header">Customer Details</div>
        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label>Customer Search</label>
                    <div class="customer-search-container">
                        <input type="text" class="form-control" [(ngModel)]="customerSearchTerm"
                            (input)="onCustomerSearch()" name="custSearch" placeholder="Search by name or phone"
                            autocomplete="off">

                        <div class="customer-results" *ngIf="showCustomerResults">
                            <div class="customer-result" *ngFor="let c of filteredCustomers"
                                (click)="selectCustomer(c)">
                                <strong>{{ c.name }}</strong><br>
                                <small>{{ c.mobile }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label>Date & Time</label>
                    <input type="datetime-local" class="form-control" name="invDate" [(ngModel)]="currentInvoice.date">
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label>Customer Name</label>
                    <input type="text" class="form-control" name="cName" [(ngModel)]="currentInvoice.customerName"
                        required autocomplete="off">
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label>Mobile Number</label>
                    <div class="input-group">
                        <span class="input-group-text">+91</span>
                        <input type="text" class="form-control" name="cMobile"
                            [(ngModel)]="currentInvoice.customerMobile" autocomplete="off" placeholder="10-digit mobile"
                            maxlength="10">
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Address</label>
            <textarea class="form-control" rows="2" name="cAddr"
                [(ngModel)]="currentInvoice.customerAddress"></textarea>
        </div>

        <!-- Device Info -->
        <div class="form-section-header">Device Information</div>

        <div class="form-group">
            <label>Device Type</label>
            <select class="form-control" name="dType" [(ngModel)]="currentInvoice.deviceType">
                <option value="">Select Device Type</option>
                <option *ngFor="let t of deviceTypes" [value]="t">{{t}}</option>
            </select>
        </div>

        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label>Brand</label>
                    <select class="form-control" name="dBrand" [(ngModel)]="currentInvoice.deviceBrand">
                        <option value="">Select Brand</option>
                        <optgroup *ngFor="let group of deviceBrands" [label]="group.category">
                            <option *ngFor="let b of group.brands" [value]="b">{{b}}</option>
                        </optgroup>
                    </select>
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label>Model</label>
                    <input type="text" class="form-control" name="dModel" [(ngModel)]="currentInvoice.deviceModel">
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label>IMEI / Serial</label>
                    <input type="text" class="form-control" name="dImei" [(ngModel)]="currentInvoice.deviceImei">
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label>Issues</label>
                    <select class="form-control" name="dIssues" [(ngModel)]="currentInvoice.deviceIssues">
                        <option value="">Select Issue</option>
                        <optgroup *ngFor="let group of repairProblems" [label]="group.category">
                            <option *ngFor="let p of group.problems" [value]="p">{{ p }}</option>
                        </optgroup>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Accessories</label>
            <input type="text" class="form-control" name="dAcc" [(ngModel)]="currentInvoice.deviceAccessories">
        </div>

        <!-- ITEMS -->
        <div class="form-section-header" style="display: flex; justify-content: space-between; align-items: center;">
            <span>Services & Parts</span>
            <button type="button" class="btn btn-primary btn-sm" (click)="addItem()">
                <i class="fas fa-plus"></i> Add Item
            </button>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Description</th>
                    <th style="width: 80px;">Qty</th>
                    <th>Price</th>
                    <th>Warranty</th>
                    <th>Total</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let item of currentInvoice.items; let i = index">
                    <td>
                        <select class="form-control" [(ngModel)]="item.type" [name]="'iType'+i">
                            <option value="service">Service</option>
                            <option value="part">Part</option>
                        </select>
                    </td>
                    <td>
                        <input *ngIf="item.type === 'service'" type="text" class="form-control"
                            [(ngModel)]="item.description" [name]="'iDesc'+i" placeholder="Enter Description">
                        <select *ngIf="item.type === 'part'" class="form-control" [(ngModel)]="item.description"
                            [name]="'iDesc'+i">
                            <option value="">Select Description</option>
                            <optgroup *ngFor="let group of spareParts" [label]="group.category">
                                <option *ngFor="let part of group.parts" [value]="part">{{ part }}</option>
                            </optgroup>
                        </select>
                    </td>
                    <td><input type="number" class="form-control" [(ngModel)]="item.quantity" [name]="'iQty'+i"
                            (change)="calculateRowTotal(item)"></td>
                    <td><input type="number" class="form-control" [(ngModel)]="item.price" [name]="'iPrice'+i"
                            (change)="calculateRowTotal(item)"></td>
                    <td>
                        <select class="form-control" [(ngModel)]="item.warranty" [name]="'iWar'+i">
                            <option value="No Warranty">No Warranty</option>
                            <option value="1 Month">1 Month</option>
                            <option value="3 Months">3 Months</option>
                            <option value="6 Months">6 Months</option>
                            <option value="1 Year">1 Year</option>
                        </select>
                    </td>
                    <td>{{ item.total | currency:'INR' }}</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" (click)="removeItem(i)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>


        <!-- TOTALS -->
        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label>Subtotal</label>
                    <input type="text" class="form-control" [value]="currentInvoice.subtotal" readonly>
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label>Tax (%)</label>
                    <input type="number" class="form-control" name="tax" [(ngModel)]="currentInvoice.taxPercent"
                        (change)="calculateTotals()">
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label>Discount</label>
                    <input type="number" class="form-control" name="discount" [(ngModel)]="currentInvoice.discount"
                        (change)="calculateTotals()">
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label>Total Amount</label>
                    <input type="text" class="form-control" [value]="currentInvoice.totalAmount" readonly
                        style="font-weight:bold; color: var(--primary);">
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label>Payment Status</label>
                    <select class="form-control" name="pStatus" [(ngModel)]="currentInvoice.paymentStatus"
                        (change)="onPaymentStatusChange()">
                        <option value="Paid">Paid</option>
                        <option value="Cash">Cash</option>
                        <option value="Google Pay">Google Pay</option>
                        <option value="Pending">Pending</option>
                    </select>
                </div>
            </div>
            <div class="form-col" *ngIf="currentInvoice.paymentStatus === 'Pending'">
                <div class="form-group">
                    <label>Amount Paid</label>
                    <input type="number" class="form-control" name="amtPaid" [(ngModel)]="currentInvoice.amountPaid"
                        (change)="calculateBalance()">
                </div>
            </div>
            <div class="form-col" *ngIf="currentInvoice.paymentStatus === 'Pending'">
                <div class="form-group">
                    <label>Balance Due</label>
                    <input type="text" class="form-control" [value]="currentInvoice.balanceDue" readonly
                        style="color: red;">
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Warranty Info</label>
            <textarea class="form-control" name="warInfo" [(ngModel)]="currentInvoice.warrantyInfo"></textarea>
        </div>

        <div class="action-buttons">
            <button type="button" class="btn btn-primary" (click)="togglePreview()">
                <i class="fas fa-eye"></i> Preview Invoice
            </button>
            <button type="button" class="btn btn-success" (click)="saveInvoice()">
                <i class="fas fa-floppy-disk"></i> Save Invoice
            </button>
        </div>
    </form>
</div>

<!-- ================= PREVIEW SECTION ================= -->
<div class="card" id="invoicePreview" *ngIf="$any(viewMode) === 'preview'">
    <div class="card-header no-print">
        <div class="card-title">Invoice Preview</div>
        <div class="action-buttons">
            <button type="button" class="btn btn-sm" (click)="togglePreview()">
                <i class="fas fa-arrow-left"></i> Edit
            </button>
            <button type="button" class="btn btn-warning" (click)="printInvoice()">
                <i class="fas fa-print"></i> Print
            </button>
            <button type="button" class="btn btn-success" (click)="saveInvoice()">
                <i class="fas fa-check"></i> Save
            </button>
        </div>
    </div>

    <div class="invoice-print">
        <!-- Header -->
        <div class="print-header">
            <div class="shop-details">
                <h2>DeepMobile Repairing</h2>
                <p>Shop 27, Nagarseth Chamber</p>
                <p>Gunjan, Vapi-396191</p>
                <p>Phone: +91 7405433726</p>
            </div>
            <div class="invoice-details">
                <h3>INVOICE</h3>
                <p class="ticket-id">{{ currentInvoice.id }}</p>
                <p>Date: {{ currentInvoice.date | date:'mediumDate' }}</p>
            </div>
        </div>

        <div class="print-row">
            <div class="print-col">
                <h4>Bill To</h4>
                <p><strong>Name:</strong> {{ currentInvoice.customerName }}</p>
                <p><strong>Mobile:</strong> {{ currentInvoice.customerMobile }}</p>
                <p><strong>Address:</strong> {{ currentInvoice.customerAddress || '-' }}</p>
            </div>
            <div class="print-col">
                <h4>Device Details</h4>
                <p><strong>Device:</strong> {{ currentInvoice.deviceBrand }} {{ currentInvoice.deviceModel }}</p>
                <p><strong>IMEI:</strong> {{ currentInvoice.deviceImei || '-' }}</p>
                <p><strong>Issue:</strong> {{ currentInvoice.deviceIssues || '-' }}</p>
            </div>
        </div>

        <div class="print-section">
            <table class="print-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Description</th>
                        <th style="text-align: center;">Qty</th>
                        <th style="text-align: right;">Price</th>
                        <th style="text-align: center;">Warranty</th>
                        <th style="text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of currentInvoice.items">
                        <td>{{ item.description }}<span *ngIf="item.type==='part'"> (Part)</span></td>
                        <td style="text-align: center;">{{ item.quantity }}</td>
                        <td style="text-align: right;">{{ item.price | currency:'INR' }}</td>
                        <td style="text-align: center;">{{ item.warranty }}</td>
                        <td style="text-align: right;">{{ item.total | currency:'INR' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="print-section">
            <table class="financial-table">
                <tr>
                    <td>Subtotal:</td>
                    <td>{{ currentInvoice.subtotal | currency:'INR' }}</td>
                </tr>
                <tr *ngIf="currentInvoice.taxPercent > 0">
                    <td>Tax ({{ currentInvoice.taxPercent }}%):</td>
                    <td>{{ (currentInvoice.subtotal * currentInvoice.taxPercent / 100) | currency:'INR' }}</td>
                </tr>
                <tr *ngIf="currentInvoice.discount > 0">
                    <td>Discount:</td>
                    <td>-{{ currentInvoice.discount | currency:'INR' }}</td>
                </tr>
                <tr class="total-row">
                    <td>Total Amount:</td>
                    <td>{{ currentInvoice.totalAmount | currency:'INR' }}</td>
                </tr>
                <tr>
                    <td>Payment Status:</td>
                    <td>{{ currentInvoice.paymentStatus }}</td>
                </tr>
                <tr *ngIf="currentInvoice.balanceDue > 0">
                    <td>Balance Due:</td>
                    <td style="color: red;">{{ currentInvoice.balanceDue | currency:'INR' }}</td>
                </tr>
            </table>
        </div>

        <div class="print-footer">
            <div class="terms">
                <h5>Terms & Conditions</h5>
                <p style="white-space: pre-wrap;">{{ currentInvoice.warrantyInfo }}</p>
                <p>1. Warranty valid only for manufacturing defects.</p>
                <p>2. Physical/Liquid damage not covered.</p>
                <p>3. Component level repair logic board warranty 30 days only.</p>
                <p>4. No guarantee/warranty for water damage devices.</p>
            </div>
            <div class="signatures">
                <div class="sig-box">
                    <p>Customer Signature</p>
                </div>
                <div class="sig-box">
                    <p>Authorized Signatory</p>
                </div>
            </div>
            <p class="thank-you">Thank you for your business!</p>
        </div>
    </div>
</div>
<app-confirm-modal [isVisible]="isConfirmOpen"
    message="Are you sure you want to delete this invoice? This action cannot be undone." (confirm)="confirmDelete()"
    (cancel)="isConfirmOpen = false">
</app-confirm-modal>